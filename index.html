<!DOCTYPE HTML>
<html>

<head>
  <meta charset="UTF-8">
  <title>Model testing game</title>
  <script type="text/javascript" src="elm.js"></script>
</head>

<body>
    <div id="myapp"></div>
</body>

<script type="text/javascript">

// Start the Elm application.
var app = Elm.Main.init({
    node: document.getElementById('myapp')
});

var webR;

app.ports.sendPort.subscribe(function(message) {
    if(message.msg == "init") {
        import('https://webr.r-wasm.org/latest/webr.mjs').then(
        async ({ WebR }) => {
            webR = new WebR();
            await webR.init();
            await webR.installPackages(['ggplot2', 'base64enc'])
            webR.evalR('library(ggplot2)');
            app.ports.receivePort.send({msg : "ready"})
        });
    } else if(message.msg == "gen") {
        webR.evalRString(`
            df <- data.frame(x = rnorm(100))
p <- ggplot(aes(x), data = df) + geom_histogram()
tfile <- tempfile(fileext = ".png")
ggsave(filename = tfile, plot=p)
base64enc::base64encode(tfile)
        `).then((img) => {
            app.ports.receivePort.send({msg : "image", img: img});
        });
    } else {
        console.log(message);
    }
});




</script>
</html>
